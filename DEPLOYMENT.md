## MAME Web (WASM) – Build, Hosting, Compression, and Workers

This single document explains how the GitHub Pages site, Cloudflare Worker, and local scripts work together; what each generated file is for; how compressed WASM is served; and exactly which commands to run for common changes.

### Architecture overview

- **Build artifacts (in `webdist/`)**
  - `index.html`, `starwarswasm.wasm`, `starwarswasm.js`, `starwarswasm.worker.js` (when workers enabled)
  - `roms.data` and `roms.js` (ROMs pack and JS loader)
  - Optional: `starwarswasm.wasm.br` and `starwarswasm.wasm.gz` (precompressed variants for HTTP Content‑Encoding)
  - Optional runtime helpers (e.g., `autoboot.lua` if used)

- **Origin hosting (GitHub Pages)**
  - We publish `webdist/` to the `gh-pages` branch.
  - URL: `https://rebroad.github.io/mame/`

- **Cloudflare Worker (edge proxy + headers + compressed WASM selection)**
  - Proxies a friendlier domain to the GitHub Pages origin.
  - Adds required cross‑origin isolation headers for modern WASM + threads:
    - `Cross-Origin-Opener-Policy: same-origin`
    - `Cross-Origin-Embedder-Policy: require-corp`
    - `Cross-Origin-Resource-Policy: same-origin`
  - Serves precompressed WASM (`.wasm.br` → Brotli, `.wasm.gz` → gzip) at the original `.wasm` URL when the browser indicates support (`Accept-Encoding`).
  - Public URL (via route): `https://mame.reb.ai/` → `https://rebroad.github.io/mame/`

### What each file is

- **`starwarswasm.wasm`**: The WebAssembly module.
- **`starwarswasm.js`**: Emscripten loader/glue for the WASM module and runtime.
- **`starwarswasm.worker.js`**: Created when building with workers (`-workers`). Emscripten uses this Worker to run the main thread or subsystems off the UI thread (pthreads/OffscreenCanvas/AudioWorklet). It is fetched automatically by the runtime; no manual script tag is needed.
- **`roms.data` / `roms.js`**: The packaged ROMs and the small JS bootstrapping the virtual FS.
- **`serve.mjs`**: A small local Node server (generated by `build_web.sh`) for development. It sets COOP/COEP headers and, if present, serves `starwarswasm.wasm.br`/`.gz` when the browser supports them, at the original `.wasm` URL.
- **`cloudflare-worker/worker.mjs`**: Cloudflare Worker script. In production it proxies Pages and adds headers; for development, you can point `ORIGIN` to your local server and run `wrangler dev`.

### Compressed WASM: how `.br`/`.gz` are used

- **Why both?**
  - Brotli (`.br`) is smaller and supported by all modern browsers over HTTPS. gzip (`.gz`) is provided as a fallback for older clients or intermediaries that don’t advertise Brotli.

- **Selection rules**
  - The local Node server (`serve.mjs`) and the Cloudflare Worker both inspect the request’s `Accept-Encoding`.
    - If it includes `br` and `starwarswasm.wasm.br` exists: serve it with `Content-Encoding: br` and `Content-Type: application/wasm`.
    - Else if it includes `gzip` and `.wasm.gz` exists: serve with `Content-Encoding: gzip`.
    - Else: serve the plain `.wasm` without `Content-Encoding`.
  - The URL remains `starwarswasm.wasm` in all cases; only the bytes and headers differ.

- **How to verify which one the browser loaded**
  - Browser DevTools → Network → click `starwarswasm.wasm` → check Response Headers:
    - `Content-Encoding: br` (Brotli) or `gzip` means compressed variant.
    - No `Content-Encoding` means plain `.wasm` was served.
  - Command‑line checks:
    - Local: `curl -sI -H 'Accept-Encoding: br' http://localhost:8000/starwarswasm.wasm | sed -n '1,40p'`
    - Cloudflare: `curl -sI -H 'Accept-Encoding: br' https://mame.reb.ai/starwarswasm.wasm | sed -n '1,40p'`
    - Expect `Content-Encoding: br` and `Content-Type: application/wasm`.

### Scripts

- **`./build_web.sh`**
  - Builds the WASM binary with Emscripten (unless `-no-build`), packages ROMs, generates `webdist/index.html`, optionally starts a local server, and can compress the WASM.
  - Notable flags:
    - `-no-build`: reuse existing `starwarswasm.*`; still regenerates ROMs and `index.html`.
    - `-workers`: enable WASM workers + AudioWorklet (threads path; produces `starwarswasm.worker.js`).
    - `-console-debug`: show verbose runtime logs in the browser console.
    - `-build-debug`: enable Emscripten debug link diagnostics.
    - `-link-threads N`: try parallel linking with N threads (default: CPU count).
    - `-no-regen` / `-force-regen`: control project regeneration; otherwise auto‑regen runs when script hashes change.
    - `-compress`: create `starwarswasm.wasm.br` and `starwarswasm.wasm.gz`.

- **`./deploy_web.sh`**
  - Copies `webdist/` to a temp dir, commits to `gh-pages`, and pushes to GitHub.
  - `--deploy-worker`: also deploys the Cloudflare Worker.
  - `--force`: forces a `gh-pages` commit even when unchanged.

- **Cloudflare Worker (`webdist/cloudflare-worker/worker.mjs`) + `wrangler.toml`**
  - One script works for both dev and prod. It proxies to `ORIGIN` and adds headers, plus serves precompressed `.wasm`.
  - Configure origin via `wrangler.toml`:
    - Production default: `ORIGIN = "https://rebroad.github.io/mame/"`
    - Dev override: set `[env.dev].vars.ORIGIN = "http://localhost:8000/"` and run `wrangler dev --env dev`.

### Common changes and commands

- **Update runtime settings (e.g., brightness)**
  - Edit per‑game cfg/ini (e.g., `~/.mame/cfg/starwars1.cfg` or `~/.mame/ini/starwars1.ini`).
  - Repackage without recompiling:
    ```bash
    ./build_web.sh -no-build -no-server
    ```
  - Deploy to GitHub Pages:
    ```bash
    ./deploy_web.sh
    ```

- **Change HTML/JS page behavior only**
  - Edit `build_web.sh`’s template or files in `webdist/` as needed, then:
    ```bash
    ./build_web.sh -no-build -no-server
    ./deploy_web.sh
    ```

- **Change emulator/WASM code or Emscripten settings**
  - Full rebuild:
    ```bash
    ./build_web.sh -no-server
    ```
  - Then deploy:
    ```bash
    ./deploy_web.sh
    ```

- **Enable workers (threads + OffscreenCanvas/AudioWorklet)**
  - Build with:
    ```bash
    ./build_web.sh -workers
    ```
  - You’ll see `starwarswasm.worker.js` in `webdist/` and additional thread exports in the link step.

- **Compress WASM for deployment**
  - Produce precompressed output (recommended):
    ```bash
    ./build_web.sh -compress
    ```
  - Local server and Cloudflare will automatically serve `.br` (or `.gz`) at the `.wasm` URL when supported.

### Local vs. Cloudflare behavior

- **Local**
  - `build_web.sh` writes `webdist/serve.mjs` (Node). When you let the script start the server, it:
    - Sets COOP/COEP headers for cross‑origin isolation.
    - Selects `.wasm.br`/`.gz` automatically based on `Accept-Encoding`.

- **Cloudflare**
  - The Worker proxies the GitHub Pages origin, sets COOP/COEP headers, and selects `.wasm.br`/`.gz` the same way.
  - You can also run `wrangler dev` with `ORIGIN` pointing at your local server to test the exact production logic locally.

### Verifying and diagnosing

- **Local server quick start**
  ```bash
  (cd webdist && python3 -m http.server 8000)
  open http://localhost:8000/
  ```

- **Probe production console remotely**
  ```bash
  node webdist/probe_console.js https://mame.reb.ai
  tail -n 100 webdist/console_capture.txt
  ```

- **Check cross‑origin isolation headers (Cloudflare route)**
  ```bash
  curl -sI https://mame.reb.ai/index.html | sed -n '1,40p'
  ```

- **Confirm Brotli is served**
  ```bash
  curl -sI -H 'Accept-Encoding: br' https://mame.reb.ai/starwarswasm.wasm | sed -n '1,40p'
  # Expect: Content-Encoding: br
  ```

### FAQs

- **How do I know the browser is loading the `.br` file?**
  - DevTools Network for `starwarswasm.wasm` → Response Headers: `Content-Encoding: br`.
  - Or use `curl -sI -H 'Accept-Encoding: br' <url>`.

- **Why produce both `.br` and `.gz`? Do we need both?**
  - `.br` is preferred and smaller. `.gz` is a compatibility fallback. If you control all clients and know Brotli is universal in your environment, `.gz` can be omitted; we generate both for safety.

- **Is `starwarswasm.worker.js` used?**
  - Yes, when built with `-workers`. Emscripten imports it automatically to run code in a Worker (threads/OffscreenCanvas/AudioWorklet). Keep it alongside the other artifacts.

- **Is `serve.mjs` used?**
  - Only for local development when `build_web.sh` starts a Node server or you run it manually. It is not used in production.

- **Is Cloudflare `worker.mjs` used by the local server?**
  - Not by the local Node server. You can run the Worker locally via `wrangler dev` to test the same edge logic; otherwise it’s only active on Cloudflare.

